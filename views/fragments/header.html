<!--
 * @Author: xinyuHu hxyrkcy@outlook.com
 * @Date: 2025-11-08 13:56:54
 * @LastEditors: xinyuHu hxyrkcy@outlook.com
 * @LastEditTime: 2025-11-25 00:16:38
 * @FilePath: \myapp\apos-app\views\fragments\header.html
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
-->
{% fragment header(data) %}
{% set global = data.global or {} %}
{% set rawUrl = (data.page and data.page._url) or data.url or (data.req and data.req.url) or '/' %}
{% set normalizedUrl = rawUrl or '/' %}
{% set isEnglish = normalizedUrl == '/en' or normalizedUrl == '/en/' or '/en/' in normalizedUrl %}
<header
  class="sticky top-0 z-50 bg-white bg-opacity-95 backdrop-blur-sm shadow-sm dark:bg-gray-900 dark:bg-opacity-95 dark:shadow-gray-900/40"
  data-theme-root
>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16 md:h-20">
      <div class="flex items-center">
        <a class="flex items-center" href="/" data-discover="true">
          <div class="text-2xl font-bold text-blue-600">
            {{ global.title or 'Wenaili 奈李' }}
          </div>
        </a>
      </div>

      <nav class="hidden md:flex items-center space-x-8">
        {% if global.headerNav and global.headerNav | length %}
          {% for item in global.headerNav %}
            {% set hasSubmenu = item.hasSubmenu and item.submenuItems and item.submenuItems | length %}
            {% set navKey = 'nav-' ~ loop.index0 %}
            {% set href = apos.modules['@apostrophecms/global'].linkPath(item) %}
            <div class="relative" {% if hasSubmenu %}data-nav="{{ navKey }}"{% endif %}>
              {% if hasSubmenu %}
                <button
                  type="button"
                  class="flex items-center text-gray-700 hover:text-blue-600 font-medium text-base transition-all duration-300 dark:text-gray-200 dark:hover:text-blue-400"
                  aria-haspopup="true"
                  aria-expanded="false"
                  data-nav-toggle="{{ navKey }}"
                >
                  <span>{{ item.linkText }}</span>
                  {% if item.badge %}
                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-600 dark:bg-blue-500/20 dark:text-blue-200">
                      {{ item.badge }}
                    </span>
                  {% endif %}
                  <i
                    class="fa-solid fa-chevron-down ml-1 text-xs transition-transform duration-300"
                    aria-hidden="true"
                  ></i>
                </button>
                <div
                  class="hidden absolute top-full left-1/2 md:left-0 mt-3 md:mt-2 w-60 md:w-52 -translate-x-1/2 md:translate-x-0 bg-white rounded-xl shadow-xl border border-gray-100 py-2 dark:bg-gray-800 dark:border-gray-700"
                  role="menu"
                  data-nav-menu="{{ navKey }}"
                >
                  {% for sub in item.submenuItems %}
                    {% set subHref = apos.modules['@apostrophecms/global'].linkPath(sub) %}
                    <a
                      class="block px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 hover:text-blue-600 transition-colors duration-300 dark:text-gray-200 dark:hover:bg-gray-700 dark:hover:text-blue-400"
                      href="{{ subHref }}"
                      data-discover="true"
                      role="menuitem"
                    >
                      {{ sub.linkText }}
                    </a>
                  {% endfor %}
                </div>
              {% else %}
                <a
                  class="text-gray-700 hover:text-blue-600 font-medium text-base transition-colors duration-300 dark:text-gray-200 dark:hover:text-blue-400"
                  href="{{ href }}"
                  data-discover="true"
                >
                  <span>{{ item.linkText }}</span>
                  {% if item.badge %}
                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-600 dark:bg-blue-500/20 dark:text-blue-200">
                      {{ item.badge }}
                    </span>
                  {% endif %}
                </a>
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}

        {% if global.phone %}
          <a
            href="tel:{{ global.phone }}"
            class="flex items-center text-gray-700 hover:text-blue-600 font-medium text-base transition-colors duration-300 ml-4 pl-4 border-l border-gray-200 dark:text-gray-200 dark:hover:text-blue-400 dark:border-gray-700"
          >
            <i class="fa-solid fa-phone mr-2 text-blue-600"></i>
            {{ global.phone }}
          </a>
        {% endif %}
      </nav>

      <div class="flex items-center space-x-2">
        {%if isEnglish %}
        <a
          class="hidden md:inline-flex px-3 py-2 rounded-full text-sm font-medium transition-colors duration-300 {{ 'bg-blue-600 text-white hover:bg-blue-600 dark:bg-blue-500 dark:text-white dark:hover:bg-blue-500' if not isEnglish else 'bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700' }}"
          href="/"
          data-discover="true"
          aria-label="切换到中文"
        >
          中
        </a>
        {% else %}
        <a
        class="hidden md:inline-flex px-3 py-2 rounded-full text-sm font-medium transition-colors duration-300 {{ 'bg-blue-600 text-white hover:bg-blue-600 dark:bg-blue-500 dark:text-white dark:hover:bg-blue-500' if isEnglish else 'bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700' }}"
        href="/en"
        data-discover="true"
        aria-label="Switch to English"
      >
        EN
      </a>
       
        {%endif%}
        <button
          class="hidden md:inline-flex p-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors duration-300 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700"
          aria-label="切换到暗色模式"
          data-theme-toggle
        >
          <span class="inline-flex items-center justify-center">
            <i class="fa-solid fa-moon text-base dark:hidden"></i>
            <i class="fa-solid fa-sun text-base hidden dark:inline text-amber-400"></i>
          </span>
        </button>
        <button
          class="md:hidden p-2 rounded-md text-gray-700 hover:bg-gray-100 transition-colors duration-300"
          aria-label="打开菜单"
          data-mobile-menu-toggle
        >
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
      </div>
    </div>
  </div>

  <div
    class="md:hidden fixed inset-0 z-40 bg-black/40 backdrop-blur-sm hidden dark:bg-black/60"
    data-mobile-menu="overlay"
  ></div>
  <div
    class="md:hidden fixed inset-y-0 right-0 z-50 w-80 max-w-[90%] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 dark:bg-gray-900"
    data-mobile-menu="panel"
  >
    <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100 dark:border-gray-800">
      <div class="text-xl font-semibold text-gray-900 dark:text-gray-100">菜单</div>
      <button
        type="button"
        class="p-2 rounded-full text-gray-600 hover:bg-gray-100 transition-colors duration-300 dark:text-gray-300 dark:hover:bg-gray-800"
        aria-label="关闭菜单"
        data-mobile-menu-close
      >
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>

    <nav class="px-5 py-6 space-y-4">
      {% if global.headerNav and global.headerNav | length %}
        {% for item in global.headerNav %}
          {% set hasSubmenu = item.hasSubmenu and item.submenuItems and item.submenuItems | length %}
          {% set navKey = 'mobile-' ~ loop.index0 %}
          {% set href = apos.modules['@apostrophecms/global'].linkPath(item) %}

          {% if hasSubmenu %}
            <div class="border border-gray-100 rounded-lg dark:border-gray-800" data-mobile-disclosure="{{ navKey }}">
              <button
                type="button"
                class="w-full flex items-center justify-between px-4 py-3 text-gray-800 font-medium text-base dark:text-gray-100"
                data-mobile-disclosure-toggle="{{ navKey }}"
                aria-expanded="false"
              >
                <span>
                  {{ item.linkText }}
                  {% if item.badge %}
                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-600 dark:bg-blue-500/20 dark:text-blue-200">
                      {{ item.badge }}
                    </span>
                  {% endif %}
                </span>
                <i class="fa-solid fa-chevron-down text-xs transition-transform duration-300"></i>
              </button>
              <div class="hidden border-t border-gray-100 dark:border-gray-800" data-mobile-disclosure-panel="{{ navKey }}">
                {% for sub in item.submenuItems %}
                  {% set subHref = apos.modules['@apostrophecms/global'].linkPath(sub) %}
                  <a
                    class="block px-4 py-2 text-sm text-gray-600 dark:text-gray-300"
                    href="{{ subHref }}"
                    data-discover="true"
                  >
                    {{ sub.linkText }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <a
              class="block text-gray-800 font-medium text-base dark:text-gray-100"
              href="{{ href }}"
              data-discover="true"
            >
              <span>{{ item.linkText }}</span>
              {% if item.badge %}
                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-600 dark:bg-blue-500/20 dark:text-blue-200">
                  {{ item.badge }}
                </span>
              {% endif %}
            </a>
          {% endif %}
        {% endfor %}
      {% endif %}

      <div class="flex items-center justify-between gap-3 px-4 py-3 bg-gray-50 rounded-lg dark:bg-gray-800">
        <a
          href="/en"
          data-discover="true"
          class="flex-1 text-center px-3 py-2 rounded-full text-sm font-medium transition-colors duration-300 {{ 'bg-blue-600 text-white hover:bg-blue-600 dark:bg-blue-500 dark:text-white dark:hover:bg-blue-500' if isEnglish else 'bg-white text-gray-700 hover:bg-gray-100 dark:bg-gray-900 dark:text-gray-200 dark:hover:bg-gray-700' }}"
        >
          EN
        </a>
        <a
          href="/"
          data-discover="true"
          class="flex-1 text-center px-3 py-2 rounded-full text-sm font-medium transition-colors duration-300 {{ 'bg-blue-600 text-white hover:bg-blue-600 dark:bg-blue-500 dark:text-white dark:hover:bg-blue-500' if not isEnglish else 'bg-white text-gray-700 hover:bg-gray-100 dark:bg-gray-900 dark:text-gray-200 dark:hover:bg-gray-700' }}"
        >
          中
        </a>
      </div>

      <button
        class="w-full flex items-center justify-between px-4 py-3 bg-gray-100 rounded-lg text-gray-800 font-semibold dark:bg-gray-800 dark:text-gray-100"
        type="button"
        data-theme-toggle
        aria-label="切换到暗色模式"
      >
        <span data-theme-text>切换到暗色模式</span>
        <span class="inline-flex items-center justify-center">
          <i class="fa-solid fa-moon text-base dark:hidden"></i>
          <i class="fa-solid fa-sun text-base hidden dark:inline text-amber-400"></i>
        </span>
      </button>

      {% if global.phone %}
        <a
          class="flex items-center justify-between px-4 py-3 bg-blue-50 rounded-lg text-blue-600 font-semibold dark:bg-blue-500/10 dark:text-blue-300"
          href="tel:{{ global.phone }}"
        >
          <span>立即咨询</span>
          <span>{{ global.phone }}</span>
        </a>
      {% endif %}
    </nav>
  </div>
</header>

<script data-apos-asset type="module">
  const handleDesktopDropdowns = (() => {
    const toggles = document.querySelectorAll('[data-nav-toggle]');
    if (!toggles.length) {
      return;
    }

    let activeKey = null;

    const closeMenu = (key) => {
      if (!key) {
        return;
      }
      const toggle = document.querySelector(`[data-nav-toggle="${key}"]`);
      const menu = document.querySelector(`[data-nav-menu="${key}"]`);
      if (!toggle || !menu) {
        return;
      }
      menu.classList.add('hidden');
      toggle.setAttribute('aria-expanded', 'false');
      toggle.querySelector('i')?.classList.remove('rotate-180');
    };

    const openMenu = (key) => {
      const toggle = document.querySelector(`[data-nav-toggle="${key}"]`);
      const menu = document.querySelector(`[data-nav-menu="${key}"]`);
      if (!toggle || !menu) {
        return;
      }
      menu.classList.remove('hidden');
      toggle.setAttribute('aria-expanded', 'true');
      toggle.querySelector('i')?.classList.add('rotate-180');
    };

    toggles.forEach((toggle) => {
      const key = toggle.getAttribute('data-nav-toggle');
      if (!key) {
        return;
      }

      toggle.addEventListener('click', (event) => {
        event.preventDefault();
        if (activeKey === key) {
          closeMenu(key);
          activeKey = null;
        } else {
          if (activeKey) {
            closeMenu(activeKey);
          }
          openMenu(key);
          activeKey = key;
        }
      });
    });

    document.addEventListener('click', (event) => {
      if (!activeKey) {
        return;
      }
      if (!(event.target instanceof HTMLElement)) {
        return;
      }
      const activeMenu = document.querySelector(`[data-nav="${activeKey}"]`);
      if (!activeMenu) {
        return;
      }
      if (!event.target.closest('[data-nav]') && !event.target.closest('[data-nav-menu]')) {
        closeMenu(activeKey);
        activeKey = null;
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768 && activeKey) {
        closeMenu(activeKey);
        activeKey = null;
      }
    });
  })();

  const handleMobileMenu = (() => {
    const openButtons = document.querySelectorAll('[data-mobile-menu-toggle]');
    const closeButton = document.querySelector('[data-mobile-menu-close]');
    const overlay = document.querySelector('[data-mobile-menu="overlay"]');
    const panel = document.querySelector('[data-mobile-menu="panel"]');

    if (!overlay || !panel) {
      return;
    }

    const openMenu = () => {
      overlay.classList.remove('hidden');
      panel.classList.remove('translate-x-full');
      document.body.classList.add('overflow-hidden');
    };

    const closeMenu = () => {
      overlay.classList.add('hidden');
      panel.classList.add('translate-x-full');
      document.body.classList.remove('overflow-hidden');
      closeAllDisclosures();
    };

    openButtons.forEach((button) => {
      button.addEventListener('click', openMenu);
    });

    closeButton?.addEventListener('click', closeMenu);
    overlay.addEventListener('click', closeMenu);

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        closeMenu();
      }
    });

    const closeAllDisclosures = () => {
      document
        .querySelectorAll('[data-mobile-disclosure-panel]')
        .forEach((panelElement) => {
          panelElement.classList.add('hidden');
        });
      document
        .querySelectorAll('[data-mobile-disclosure-toggle]')
        .forEach((toggleButton) => {
          toggleButton.setAttribute('aria-expanded', 'false');
          const icon = toggleButton.querySelector('i');
          icon?.classList.remove('rotate-180');
        });
    };

    document
      .querySelectorAll('[data-mobile-disclosure-toggle]')
      .forEach((toggleButton) => {
        const key = toggleButton.getAttribute('data-mobile-disclosure-toggle');
        if (!key) {
          return;
        }
        const panelElement = document.querySelector(
          `[data-mobile-disclosure-panel="${key}"]`
        );
        if (!panelElement) {
          return;
        }
        toggleButton.addEventListener('click', () => {
          const isOpen = toggleButton.getAttribute('aria-expanded') === 'true';
          closeAllDisclosures();
          if (!isOpen) {
            panelElement.classList.remove('hidden');
            toggleButton.setAttribute('aria-expanded', 'true');
            const icon = toggleButton.querySelector('i');
            icon?.classList.add('rotate-180');
          }
        });
      });
  })();

  const handleThemeToggle = (() => {
    const toggles = document.querySelectorAll('[data-theme-toggle]');
    if (!toggles.length) {
      return;
    }

    const THEME_STORAGE_KEY = 'wenaili-theme';
    const root = document.documentElement;
    const prefersDark = typeof window.matchMedia === 'function'
      ? window.matchMedia('(prefers-color-scheme: dark)')
      : null;

    const updateToggleState = (isDark) => {
      toggles.forEach((toggle) => {
        toggle.setAttribute('aria-label', isDark ? '切换到亮色模式' : '切换到暗色模式');
        const textTarget = toggle.querySelector('[data-theme-text]');
        if (textTarget) {
          textTarget.textContent = isDark ? '切换到亮色模式' : '切换到暗色模式';
        }
      });
    };

    const applyTheme = (theme) => {
      const isDark = theme === 'dark';
      root.classList.toggle('dark', isDark);
      root.dataset.theme = isDark ? 'dark' : 'light';
      updateToggleState(isDark);
    };

    const resolveInitialTheme = () => {
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      if (stored === 'dark' || stored === 'light') {
        return stored;
      }
      if (prefersDark?.matches) {
        return 'dark';
      }
      return 'light';
    };

    let currentTheme = resolveInitialTheme();
    applyTheme(currentTheme);

    prefersDark?.addEventListener('change', (event) => {
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      if (stored === 'dark' || stored === 'light') {
        return;
      }
      currentTheme = event.matches ? 'dark' : 'light';
      applyTheme(currentTheme);
    });

    toggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem(THEME_STORAGE_KEY, currentTheme);
        applyTheme(currentTheme);
      });
    });
  })();
</script>
{% endfragment %}